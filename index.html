<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WORD SHOOTING: ONLINE</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Noto+Sans+JP:wght@400;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --neon-cyan: #00f3ff;
            --neon-pink: #ff00ff;
            --neon-yellow: #ffff00;
            --bg-dark: #050505;
            --danger: #ff003c;
        }

        body {
            background-color: var(--bg-dark);
            color: #fff;
            font-family: 'Orbitron', 'Noto Sans JP', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            touch-action: manipulation;
        }

        #app { width: 100%; max-width: 500px; padding: 15px; box-sizing: border-box; position: relative; }
        .screen { display: none; flex-direction: column; gap: 15px; }
        .active { display: flex; }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--neon-cyan);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.3);
            position: relative;
        }

        .main-title {
            text-align: center;
            color: var(--neon-cyan);
            text-shadow: 0 0 10px var(--neon-cyan), 0 0 20px var(--neon-cyan);
            font-size: 2.2rem;
            margin: 15px 0;
            letter-spacing: 3px;
            font-weight: 700;
        }

        .room-display {
            font-size: 0.85rem;
            color: var(--neon-cyan);
            text-align: right;
            margin-bottom: 5px;
            letter-spacing: 2px;
            font-weight: bold;
        }

        .genre-badge {
            background: var(--neon-pink);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 900;
            display: inline-block;
            margin: 10px 0;
            font-size: 1.4rem;
            box-shadow: 0 0 10px var(--neon-pink);
        }

        button {
            background: transparent; color: var(--neon-cyan); border: 2px solid var(--neon-cyan);
            padding: 15px; font-weight: bold; cursor: pointer; font-size: 1.1rem;
            transition: 0.2s;
            text-transform: uppercase;
        }
        button:active { background: var(--neon-cyan); color: #000; }
        button:disabled { border-color: #444; color: #444; opacity: 0.5; }

        /* キーボード */
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; }
        .key {
            padding: 12px 0; font-size: 1.2rem; background: #111; border: 1px solid #333;
            color: #ccc; text-align: center; border-radius: 4px;
            display: flex; justify-content: center; align-items: center;
            min-height: 50px;
        }
        .key.hit { background: var(--neon-pink); color: white; border-color: white; box-shadow: 0 0 10px var(--neon-pink); }
        .key.miss { opacity: 0.2; }
        .key.active-key { border-color: var(--neon-cyan); color: var(--neon-cyan); background: #1a1a1a; box-shadow: inset 0 0 5px var(--neon-cyan); }

        #player-list { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .player-card {
            background: #111; border-left: 4px solid #444; padding: 10px; font-size: 0.85rem;
            border-radius: 4px;
        }
        .player-card.active-turn { border-left-color: var(--neon-cyan); box-shadow: 0 0 15px var(--neon-cyan); background: #222; }
        .player-card.eliminated { border-left-color: var(--danger); opacity: 0.4; }

        .input-display {
            background: #000; border-bottom: 3px solid var(--neon-pink);
            height: 50px; font-size: 1.8rem; display: flex; justify-content: center; align-items: center;
            margin-bottom: 15px; letter-spacing: 4px; color: var(--neon-yellow);
        }

        #lobby-list { list-style: none; padding: 0; text-align: left; }
        #lobby-list li { padding: 10px; border-bottom: 1px solid #222; color: var(--neon-cyan); font-weight: bold; }

        .version-tag { position: fixed; bottom: 5px; right: 10px; font-size: 0.7rem; color: #444; }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); display: none; flex-direction: column;
            justify-content: flex-start; align-items: center; z-index: 1000; padding: 20px; box-sizing: border-box;
            overflow-y: auto;
        }
        .modal-content { width: 100%; max-width: 450px; padding-top: 20px; }

        .shake { animation: shake-anim 0.4s ease-in-out; }
        @keyframes shake-anim {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-8px); }
            40%, 80% { transform: translateX(8px); }
        }

        /* ログイン画面専用スタイル */
        .login-sub-screen { display: none; flex-direction: column; gap: 10px; width: 100%; }
        .login-sub-screen.active { display: flex; }
        input {
            width: 100%; padding: 12px; background: #000; border: 1px solid var(--neon-cyan);
            color: #fff; box-sizing: border-box; font-size: 1rem;
        }
    </style>
</head>
<body id="main-body">

<div id="app">
    <div class="main-title">WORD SHOOTING</div>

    <!-- 1. ログイン -->
    <div id="login-screen" class="screen active">
        <!-- メインメニュー -->
        <div id="login-main" class="login-sub-screen active">
            <button onclick="showLoginFlow('create')" style="width:100%; margin-bottom:15px;">CREATE SESSION (ルームを作る)</button>
            <button onclick="showLoginFlow('join')" style="width:100%">JOIN SESSION (ルームに入る)</button>
        </div>

        <!-- ルーム作成フォーム -->
        <div id="login-create" class="login-sub-screen">
            <div class="panel">
                <h3 style="color:var(--neon-cyan); margin-top:0;">CREATE MISSION</h3>
                <input type="text" id="create-name" placeholder="YOUR NAME" maxlength="8" style="margin-bottom:10px;">
                <input type="text" id="create-room-id" placeholder="SET ROOM KEY (自由な文字)" style="margin-bottom:15px;">
                <button onclick="joinRoom('create')" style="width:100%; margin-bottom:10px;">START LOBBY</button>
                <button onclick="showLoginFlow('main')" style="width:100%; border-color:#666; color:#666; padding:10px;">BACK</button>
            </div>
        </div>

        <!-- ルーム参加フォーム -->
        <div id="login-join" class="login-sub-screen">
            <div class="panel">
                <h3 style="color:var(--neon-pink); margin-top:0;">JOIN MISSION</h3>
                <input type="text" id="join-name" placeholder="YOUR NAME" maxlength="8" style="margin-bottom:10px;">
                <input type="text" id="join-room-id" placeholder="ENTER ROOM KEY" style="margin-bottom:15px;">
                <button onclick="joinRoom('join')" style="width:100%; margin-bottom:10px;">ENTER LOBBY</button>
                <button onclick="showLoginFlow('main')" style="width:100%; border-color:#666; color:#666; padding:10px;">BACK</button>
            </div>
        </div>
    </div>

    <!-- 2. ロビー -->
    <div id="lobby-screen" class="screen">
        <div class="room-display">TARGET ROOM: <span class="current-room-text">----</span></div>
        <div class="panel" style="text-align:center">
            <h3 style="color:var(--neon-pink); margin-top:0;">READY FOR MISSION</h3>
            <p>MEMBERS: <span id="player-count">0</span> / 10</p>
            <ul id="lobby-list"></ul>
            <button id="start-btn" onclick="startGameSession()" style="width:100%; margin-top:20px;">START MISSION</button>
        </div>
    </div>

    <!-- 3. セットアップ -->
    <div id="setup-screen" class="screen">
        <div class="room-display">ROOM: <span class="current-room-text">----</span></div>
        <div class="panel" style="text-align:center">
            <div id="genre-display" class="genre-badge">---</div>
            <p style="font-size:0.9rem; margin:10px 0;">TARGET WORD (MAX 8 CHARS)</p>
            <div class="input-display" id="setup-word-view"></div>
            <div class="grid" id="setup-kb"></div>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button onclick="backspace('setup')" style="flex:1">DEL</button>
                <button id="ready-btn" onclick="confirmSecretWord()" style="flex:2">LOAD AMMO</button>
            </div>
        </div>
        <p id="setup-wait-msg" style="text-align:center; color:var(--neon-pink); font-weight:bold;"></p>
    </div>

    <!-- 4. バトル -->
    <div id="battle-screen" class="screen">
        <div class="room-display">ROOM: <span class="current-room-text">----</span></div>
        <div id="battle-genre" class="genre-badge" style="text-align:center; align-self:center">---</div>
        <div id="player-list"></div>
        <div id="turn-msg" style="text-align:center; color:var(--neon-yellow); font-weight:bold; margin:10px 0;"></div>
        <div class="grid" id="attack-grid"></div>
        <button id="expose-open-btn" class="danger" style="border-color:var(--neon-pink); color:var(--neon-pink); margin-top:15px;" onclick="openExposeModal()">【一撃】SNIPE</button>
        <button id="reset-btn" style="display:none; margin-top:15px;" onclick="resetGame()">PLAY AGAIN</button>
    </div>

    <div class="version-tag">WORD SHOOTING v1.1</div>
</div>

<!-- SNIPE(あばく)モーダル -->
<div id="expose-modal" class="modal">
    <div class="modal-content">
        <h2 style="color:var(--neon-pink); text-align:center; margin-top:0;">SNIPE SYSTEM</h2>
        <div class="panel" style="border-color:var(--neon-pink); margin-bottom:15px;">
            <p style="margin-top:0; font-size:0.8rem;">SELECT TARGET:</p>
            <select id="target-select" style="width:100%; padding:12px; background:#222; color:#fff; border:1px solid var(--neon-pink); font-size:1.1rem;"></select>
        </div>
        <div class="input-display" id="expose-word-view"></div>
        <div class="grid" id="expose-kb"></div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; width:100%; margin-top:20px;">
            <button onclick="closeExposeModal()" style="border-color:#666; color:#666;">ABORT</button>
            <button onclick="backspace('expose')">DEL</button>
            <button style="border-color:var(--neon-pink); color:var(--neon-pink); grid-column: span 2; font-size: 1.3rem;" onclick="executeExpose()">SHOOT! (FIRE!)</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyBpVZkp8eaTwyove6n3i9SE0asIUbYKmjY",
      authDomain: "aiue-battle-online.firebaseapp.com",
      databaseURL: "https://aiue-battle-online-default-rtdb.firebaseio.com",
      projectId: "aiue-battle-online",
      storageBucket: "aiue-battle-online.firebasestorage.app",
      messagingSenderId: "1032584345696",
      appId: "1:1032584345696:web:aa3b9ceb4cfed976236b05"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let roomId, myId, myName;
    let currentInput = "";
    const chars = "あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわをんー".split("");
    const genres = ["動物", "食べ物", "スポーツ", "国名", "乗り物", "体の一部", "文房具", "都道府県", "学校にあるもの", "キャラクター", "アニメ", "楽器", "虫", "魚", "家電", "冬のもの", "有名人"];

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo(0,0);
    }

    function showLoginFlow(type) {
        document.querySelectorAll('.login-sub-screen').forEach(s => s.classList.remove('active'));
        document.getElementById('login-' + type).classList.add('active');
    }

    function createKeyboard(containerId, callback) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";
        chars.forEach(c => {
            const k = document.createElement('div');
            k.className = 'key';
            k.innerText = c;
            k.onclick = (e) => { e.preventDefault(); callback(c); };
            container.appendChild(k);
        });
    }

    function joinRoom(type) {
        roomId = document.getElementById(type + '-room-id').value.trim();
        myName = document.getElementById(type + '-name').value.trim();
        
        if (!roomId || !myName) return alert("ENTER ROOM ID & NAME!");
        myId = Math.random().toString(36).substring(2, 10);

        document.querySelectorAll('.current-room-text').forEach(el => el.innerText = roomId);

        const roomRef = db.ref(`rooms/${roomId}`);
        roomRef.child('players').child(myId).set({
            name: myName, isReady: false, isOut: false, hits: []
        });

        roomRef.child('players').child(myId).onDisconnect().remove();

        listenToRoom();
        showScreen('lobby-screen');
    }

    function listenToRoom() {
        db.ref(`rooms/${roomId}`).on('value', snap => {
            const data = snap.val();
            if (!data) return;

            const players = data.players || {};
            const playerIds = Object.keys(players);
            const status = data.config?.status || 'waiting';

            if (status === 'waiting') {
                showScreen('lobby-screen');
                document.getElementById('player-count').innerText = playerIds.length;
                const list = document.getElementById('lobby-list');
                list.innerHTML = "";
                playerIds.forEach(id => {
                    const li = document.createElement('li');
                    li.innerText = `LOCKED ON > ${players[id].name}`;
                    list.appendChild(li);
                });
            }

            if (status === 'setup') {
                showScreen('setup-screen');
                document.getElementById('genre-display').innerText = `TARGET: ${data.config.genre}`;
                if (document.getElementById('setup-kb').innerHTML === "") {
                    createKeyboard('setup-kb', (c) => {
                        if (currentInput.length < 8) {
                            currentInput += c;
                            document.getElementById('setup-word-view').innerText = currentInput;
                        }
                    });
                }
                
                const allReady = playerIds.length >= 1 && playerIds.every(id => players[id].isReady);
                if (allReady) {
                    db.ref(`rooms/${roomId}/config`).update({ status: 'playing' });
                    if (!data.turn) db.ref(`rooms/${roomId}`).update({ turn: playerIds[0] });
                }

                if (players[myId]?.isReady) {
                    document.getElementById('ready-btn').disabled = true;
                    document.getElementById('ready-btn').innerText = "LOADED";
                    document.getElementById('setup-wait-msg').innerText = "WAITING FOR OTHERS...";
                } else {
                    document.getElementById('ready-btn').disabled = false;
                    document.getElementById('ready-btn').innerText = "LOAD AMMO";
                    document.getElementById('setup-wait-msg').innerText = "";
                }
            }

            if (status === 'playing') {
                showScreen('battle-screen');
                updateBattleUI(data);
            }

            if (status === 'finished') {
                document.getElementById('reset-btn').style.display = 'block';
                document.getElementById('turn-msg').innerText = "MISSION COMPLETED";
            } else {
                document.getElementById('reset-btn').style.display = 'none';
            }
        });
    }

    function startGameSession() {
        const newGenre = genres[Math.floor(Math.random() * genres.length)];
        db.ref(`rooms/${roomId}/config`).set({ status: 'setup', genre: newGenre });
    }

    function confirmSecretWord() {
        if (currentInput.length === 0) return alert("ENTER AT LEAST 1 CHAR!");
        db.ref(`rooms/${roomId}/players/${myId}`).update({ word: currentInput, isReady: true });
        currentInput = "";
    }

    function updateBattleUI(data) {
        const players = data.players;
        const playerIds = Object.keys(players);
        
        document.getElementById('battle-genre').innerText = `TARGET: ${data.config.genre}`;
        const listDiv = document.getElementById('player-list');
        listDiv.innerHTML = "";
        const targetSelect = document.getElementById('target-select');
        targetSelect.innerHTML = "";

        playerIds.forEach(id => {
            const p = players[id];
            const card = document.createElement('div');
            card.className = `player-card ${id === data.turn ? 'active-turn' : ''} ${p.isOut ? 'eliminated' : ''}`;
            
            const display = p.word.split("").map(c => 
                (p.hits && p.hits.includes(c)) ? `<span style="color:var(--neon-pink)">${c}</span>` : (id === myId ? c : "？")
            ).join("");

            card.innerHTML = `<strong>${p.name}</strong><br>[ ${display} ]`;
            listDiv.appendChild(card);

            if (id !== myId && !p.isOut) {
                const opt = document.createElement('option');
                opt.value = id; opt.innerText = p.name;
                targetSelect.appendChild(opt);
            }
        });

        const isMyTurn = data.turn === myId && !players[myId].isOut;
        document.getElementById('turn-msg').innerText = isMyTurn ? "YOUR TURN: SHOOT!" : `${players[data.turn]?.name} IS AIMING...`;
        document.getElementById('expose-open-btn').style.display = isMyTurn ? 'block' : 'none';

        const grid = document.getElementById('attack-grid');
        grid.innerHTML = "";
        chars.forEach(c => {
            const k = document.createElement('div');
            k.className = `key ${data.usedChars?.[c] || ''}`;
            k.innerText = c;
            if (isMyTurn && !data.usedChars?.[c]) {
                k.onclick = () => attack(c);
                k.classList.add('active-key');
            }
            grid.appendChild(k);
        });
    }

    async function attack(char) {
        const snap = await db.ref(`rooms/${roomId}`).get();
        const data = snap.val();
        let hitAny = false;
        const players = data.players;

        Object.keys(players).forEach(id => {
            if (players[id].isOut) return;
            if (players[id].word.includes(char)) {
                hitAny = true;
                const newHits = players[id].hits ? [...new Set([...players[id].hits, char])] : [char];
                const isOut = players[id].word.split("").every(c => newHits.includes(c));
                db.ref(`rooms/${roomId}/players/${id}`).update({ hits: newHits, isOut: isOut });
                if (hitAny) triggerShake();
            }
        });
        nextTurn(data, char, hitAny ? 'hit' : 'miss');
    }

    function backspace(type) {
        currentInput = currentInput.slice(0, -1);
        document.getElementById(type + '-word-view').innerText = currentInput;
    }

    function openExposeModal() {
        currentInput = "";
        document.getElementById('expose-word-view').innerText = "";
        document.getElementById('expose-modal').style.display = 'flex';
        createKeyboard('expose-kb', (c) => {
            if (currentInput.length < 8) {
                currentInput += c;
                document.getElementById('expose-word-view').innerText = currentInput;
            }
        });
    }
    function closeExposeModal() { document.getElementById('expose-modal').style.display = 'none'; }

    async function executeExpose() {
        const targetId = document.getElementById('target-select').value;
        if (!targetId || !currentInput) return alert("SELECT TARGET & WORD!");
        const snap = await db.ref(`rooms/${roomId}`).get();
        const data = snap.val();
        const target = data.players[targetId];

        if (target.word === currentInput) {
            db.ref(`rooms/${roomId}/players/${targetId}`).update({ isOut: true, hits: target.word.split("") });
            triggerShake();
        } else {
            db.ref(`rooms/${roomId}/players/${myId}`).update({ isOut: true });
        }
        closeExposeModal();
        nextTurn(data, `[${currentInput}]`, 'hit');
    }

    function nextTurn(data, char, result) {
        const ids = Object.keys(data.players);
        const aliveIds = ids.filter(id => !data.players[id].isOut);
        if (aliveIds.length <= 1) {
            db.ref(`rooms/${roomId}/config`).update({ status: 'finished' });
            return;
        }
        let nextIdx = (ids.indexOf(data.turn) + 1) % ids.length;
        while (data.players[ids[nextIdx]].isOut) {
            nextIdx = (nextIdx + 1) % ids.length;
        }
        db.ref(`rooms/${roomId}`).update({ turn: ids[nextIdx], [`usedChars/${char}`]: result });
    }

    function triggerShake() {
        const b = document.getElementById('main-body');
        b.classList.add('shake');
        setTimeout(() => b.classList.remove('shake'), 400);
    }

    function resetGame() {
        const roomRef = db.ref(`rooms/${roomId}`);
        roomRef.get().then(snap => {
            const players = snap.val().players;
            const updates = {};
            Object.keys(players).forEach(id => {
                updates[`players/${id}/isReady`] = false;
                updates[`players/${id}/isOut`] = false;
                updates[`players/${id}/hits`] = [];
                updates[`players/${id}/word`] = "";
            });
            updates['config'] = { status: 'waiting', genre: '---' };
            updates['usedChars'] = null;
            updates['turn'] = null;
            roomRef.update(updates);
            currentInput = "";
            document.getElementById('setup-word-view').innerText = "";
            document.getElementById('setup-kb').innerHTML = "";
        });
    }
</script>
</body>
</html>
