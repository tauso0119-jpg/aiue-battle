<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WORD SHOOTING: ONLINE</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Noto+Sans+JP:wght@400;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-cyan: #00f3ff;
            --neon-pink: #ff00ff;
            --neon-yellow: #ffff00;
            --bg-dark: #050505;
            --danger: #ff003c;
        }
        body {
            background-color: var(--bg-dark);
            color: #fff;
            font-family: 'Orbitron', 'Noto Sans JP', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            touch-action: manipulation;
            overflow-x: hidden;
        }
        #app { width: 100%; max-width: 500px; padding: 15px; box-sizing: border-box; position: relative; }
        .screen { display: none; flex-direction: column; gap: 15px; }
        .active { display: flex; }
        .panel {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--neon-cyan);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.3);
            position: relative;
        }
        .main-title {
            text-align: center;
            color: var(--neon-cyan);
            text-shadow: 0 0 10px var(--neon-cyan), 0 0 20px var(--neon-cyan);
            font-size: 2.2rem;
            margin: 15px 0;
            letter-spacing: 3px;
            font-weight: 700;
        }
        .room-display {
            font-size: 0.85rem;
            color: var(--neon-cyan);
            text-align: right;
            margin-bottom: 5px;
            letter-spacing: 2px;
            font-weight: bold;
        }
        .genre-badge {
            background: var(--neon-pink);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 900;
            display: inline-block;
            margin: 10px 0;
            font-size: 1.4rem;
            box-shadow: 0 0 10px var(--neon-pink);
        }
        button {
            width: 100%; background: transparent; color: var(--neon-cyan); border: 2px solid var(--neon-cyan);
            padding: 15px; font-weight: bold; cursor: pointer; font-size: 1.1rem;
            transition: 0.2s; margin-bottom: 10px;
        }
        button:active { background: var(--neon-cyan); color: #000; box-shadow: 0 0 20px var(--neon-cyan); transform: scale(0.95); }
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; }
        .key {
            padding: 12px 0; font-size: 1.2rem; background: #111; border: 1px solid #333;
            color: #ccc; text-align: center; border-radius: 4px;
            display: flex; justify-content: center; align-items: center; min-height: 50px;
            transition: transform 0.05s, background 0.2s; user-select: none;
        }
        .key:active { transform: scale(0.85); background: var(--neon-cyan); color: #000; box-shadow: 0 0 25px var(--neon-cyan); }
        .key-flash { animation: flash-cyan 0.3s ease-out; }
        @keyframes flash-cyan {
            0% { background: #fff; box-shadow: 0 0 40px #fff; color: #000; }
            100% { background: #111; box-shadow: 0 0 0px transparent; }
        }
        .key.hit { background: var(--neon-pink); color: white; border-color: white; box-shadow: 0 0 10px var(--neon-pink); }
        .key.miss { opacity: 0.2; }
        .key.active-key { border-color: var(--neon-cyan); color: var(--neon-cyan); background: #1a1a1a; box-shadow: inset 0 0 5px var(--neon-cyan); }
        .key.empty { background: transparent; border: none; visibility: hidden; }

        #player-list { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .player-card { background: #111; border-left: 4px solid #444; padding: 10px; font-size: 0.85rem; border-radius: 4px; }
        .player-card.active-turn { border-left-color: var(--neon-cyan); box-shadow: 0 0 15px var(--neon-cyan); background: #222; }
        .player-card.eliminated { border-left-color: var(--danger); opacity: 0.4; background: #2a0000; }
        
        .input-display {
            background: #000; border-bottom: 3px solid var(--neon-pink);
            height: 50px; font-size: 1.8rem; display: flex; justify-content: center; align-items: center;
            margin-bottom: 15px; letter-spacing: 4px; color: var(--neon-yellow);
        }
        
        .target-status-display {
            background: rgba(0,0,0,0.5); border: 1px dashed var(--neon-cyan);
            padding: 10px; margin-bottom: 10px; font-size: 1.4rem; color: #fff; letter-spacing: 2px;
        }

        #flash-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: none; justify-content: center; align-items: center;
            z-index: 2000; pointer-events: none; text-align: center;
        }
        .huge-text {
            font-size: 4rem; font-weight: 900; color: #fff; text-shadow: 0 0 30px #000;
            animation: bounce 0.4s infinite alternate;
        }
        @keyframes bounce { from { transform: scale(1); } to { transform: scale(1.15); } }
        
        .shake { animation: shake-anim 0.4s ease-in-out; }
        @keyframes shake-anim {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-12px); }
            40%, 80% { transform: translateX(12px); }
        }
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); display: none; flex-direction: column;
            justify-content: flex-start; align-items: center; z-index: 1000; padding: 20px; box-sizing: border-box;
            overflow-y: auto;
        }
        .modal-content { width: 100%; max-width: 450px; padding-top: 20px; }
        input {
            width: 100%; padding: 12px; background: #000; border: 1px solid var(--neon-cyan);
            color: #fff; box-sizing: border-box; font-size: 1rem;
        }
    </style>
</head>
<body id="main-body">

<div id="flash-overlay"><div class="huge-text" id="flash-message">あばかれた！</div></div>

<div id="app">
    <div class="main-title">WORD SHOOTING</div>

    <div id="login-screen" class="screen active">
        <div id="login-main" style="display: flex; flex-direction: column; gap: 10px;">
            <button onclick="showLoginFlow('create')">ルームを作る</button>
            <button onclick="showLoginFlow('join')">ルームに入る</button>
        </div>
        <div id="login-create" class="screen">
            <div class="panel">
                <h3>ルーム新規作成</h3>
                <input type="text" id="create-name" placeholder="あなたの名前" maxlength="8">
                <input type="text" id="create-room-id" placeholder="ルーム番号" style="margin-top:10px;">
                <button onclick="joinRoom('create')" style="margin-top:20px;">作成する</button>
                <button onclick="location.reload()" style="border-color:#666; color:#666;">もどる</button>
            </div>
        </div>
        <div id="login-join" class="screen">
            <div class="panel">
                <h3>ルームに参加</h3>
                <input type="text" id="join-name" placeholder="あなたの名前" maxlength="8">
                <input type="text" id="join-room-id" placeholder="ルーム番号" style="margin-top:10px;">
                <button onclick="joinRoom('join')" style="margin-top:20px;">参加する</button>
                <button onclick="location.reload()" style="border-color:#666; color:#666;">もどる</button>
            </div>
        </div>
    </div>

    <div id="lobby-screen" class="screen">
        <div class="room-display">ルーム: <span class="current-room-text">----</span></div>
        <div class="panel" style="text-align:center">
            <h3 style="color:var(--neon-pink);">待機ロビー</h3>
            <p>現在の人数: <span id="player-count">0</span> / 10</p>
            <ul id="lobby-list" style="list-style: none; padding: 0;"></ul>
            <button id="start-btn" onclick="startGameSession()" style="margin-top:20px;">ミッション開始</button>
        </div>
    </div>

    <div id="setup-screen" class="screen">
        <div class="panel" style="text-align:center">
            <div id="genre-display" class="genre-badge">お題: ---</div>
            <p style="font-size:0.8rem;">自分の言葉をセットせよ(最大8文字)</p>
            <div class="input-display" id="setup-word-view"></div>
            <div class="grid" id="setup-kb"></div>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button onclick="backspace('setup')" style="flex:1">消す</button>
                <button id="ready-btn" onclick="confirmSecretWord()" style="flex:2">決定</button>
            </div>
        </div>
    </div>

    <div id="battle-screen" class="screen">
        <div class="room-display">ROOM: <span class="current-room-text">----</span></div>
        <div id="battle-genre" class="genre-badge" style="align-self:center">お題: ---</div>
        <div id="player-list"></div>
        <div id="turn-msg" style="text-align:center; color:var(--neon-yellow); font-weight:bold; margin:10px 0;"></div>
        <div class="grid" id="attack-grid"></div>
        <button id="expose-open-btn" style="border-color:var(--neon-pink); color:var(--neon-pink); margin-top:15px;" onclick="openExposeModal()">ターゲットをあばく</button>
        <button id="reset-btn" style="display:none; margin-top:15px;" onclick="resetGame()">リスタート</button>
    </div>
</div>

<div id="expose-modal" class="modal">
    <div class="modal-content">
        <h2 style="color:var(--neon-pink); text-align:center;">SNIPE SYSTEM</h2>
        <div class="panel" style="border-color:var(--neon-pink); margin-bottom:10px;">
            <p style="margin-top:0; font-size:0.8rem;">狙う相手を選択：</p>
            <select id="target-select" onchange="updateTargetPreview()" style="width:100%; padding:12px; background:#222; color:#fff; border:1px solid var(--neon-pink); font-size:1.1rem;"></select>
            <div class="target-status-display" id="target-word-preview"></div>
        </div>
        <div class="input-display" id="expose-word-view"></div>
        <div class="grid" id="expose-kb"></div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; width:100%; margin-top:20px;">
            <button onclick="closeExposeModal()">CANCEL</button>
            <button onclick="backspace('expose')">DEL</button>
            <button style="border-color:var(--neon-pink); color:var(--neon-pink); grid-column: span 2;" onclick="executeExpose()">FIRE! (決定)</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyBpVZkp8eaTwyove6n3i9SE0asIUbYKmjY",
      authDomain: "aiue-battle-online.firebaseapp.com",
      databaseURL: "https://aiue-battle-online-default-rtdb.firebaseio.com",
      projectId: "aiue-battle-online",
      storageBucket: "aiue-battle-online.firebasestorage.app",
      messagingSenderId: "1032584345696",
      appId: "1:1032584345696:web:aa3b9ceb4cfed976236b05"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let roomId, myId, myName, currentInput = "";
    let roomDataGlobal = null;
    let alreadyShownOutMsg = false; // 脱落メッセージの重複表示を防ぐ

    const charLayout = [
        "あ", "い", "う", "え", "お", "か", "き", "く", "け", "こ",
        "さ", "し", "す", "せ", "そ", "た", "ち", "つ", "て", "と",
        "な", "に", "ぬ", "ね", "の", "は", "ひ", "ふ", "へ", "ほ",
        "ま", "み", "む", "め", "も", "や", "ゆ", "よ", null, null,
        "ら", "り", "る", "れ", "ろ", "わ", "を", "ん", "ー", null
    ];

    const genres = ["動物", "食べ物", "スポーツ", "国名", "乗り物", "体の一部", "文房具", "都道府県", "学校にあるもの", "キャラクター", "アニメ", "楽器", "虫", "魚", "家電", "冬のもの", "有名人"];

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo(0,0);
    }
    function showLoginFlow(type) {
        document.getElementById('login-main').style.display = 'none';
        document.getElementById('login-' + type).classList.add('active');
    }

    function createKeyboard(containerId, callback, usedChars = {}, isMyTurn = true) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";
        charLayout.forEach(c => {
            const k = document.createElement('div');
            if (c === null) { k.className = 'key empty'; } 
            else {
                k.className = 'key'; k.innerText = c;
                if (usedChars[c]) { k.classList.add(usedChars[c]); } 
                else if (isMyTurn) {
                    k.classList.add('active-key');
                    k.onclick = (e) => { e.preventDefault(); k.classList.add('key-flash'); setTimeout(() => k.classList.remove('key-flash'), 300); callback(c); };
                }
            }
            container.appendChild(k);
        });
    }

    function joinRoom(type) {
        roomId = document.getElementById(type + '-room-id').value.trim();
        myName = document.getElementById(type + '-name').value.trim();
        if (!roomId || !myName) return alert("名前と番号を入力！");
        myId = Math.random().toString(36).substring(2, 10);
        document.querySelectorAll('.current-room-text').forEach(el => el.innerText = roomId);
        db.ref(`rooms/${roomId}/players/${myId}`).set({ name: myName, isReady: false, isOut: false, hits: [] });
        db.ref(`rooms/${roomId}/players/${myId}`).onDisconnect().remove();
        listenToRoom();
        showScreen('lobby-screen');
    }

    function listenToRoom() {
        db.ref(`rooms/${roomId}`).on('value', snap => {
            const data = snap.val();
            if (!data) return;
            roomDataGlobal = data;
            const players = data.players || {};
            const playerIds = Object.keys(players);
            const status = data.config?.status || 'waiting';

            // ★自分が脱落した瞬間の特大演出
            if (players[myId] && players[myId].isOut && !alreadyShownOutMsg) {
                showCelebration("あばかれた！\n敗北...", true);
                alreadyShownOutMsg = true;
                triggerShake();
            }

            if (status === 'waiting') {
                showScreen('lobby-screen');
                document.getElementById('player-count').innerText = playerIds.length;
                const list = document.getElementById('lobby-list'); list.innerHTML = "";
                playerIds.forEach(id => { const li = document.createElement('li'); li.innerText = `準備中: ${players[id].name}`; list.appendChild(li); });
            }
            if (status === 'setup') {
                showScreen('setup-screen');
                document.getElementById('genre-display').innerText = `お題: ${data.config.genre}`;
                if (document.getElementById('setup-kb').innerHTML === "") {
                    createKeyboard('setup-kb', (c) => { if (currentInput.length < 8) { currentInput += c; document.getElementById('setup-word-view').innerText = currentInput; } });
                }
                const allReady = playerIds.length >= 2 && playerIds.every(id => players[id].isReady);
                if (allReady) { db.ref(`rooms/${roomId}/config`).update({ status: 'playing' }); if (!data.turn) db.ref(`rooms/${roomId}`).update({ turn: playerIds[0] }); }
                if (players[myId]?.isReady) { document.getElementById('ready-btn').innerText = "完了"; document.getElementById('ready-btn').disabled = true; }
            }
            if (status === 'playing') { 
                showScreen('battle-screen'); 
                updateBattleUI(data); 
            }
            if (status === 'finished') { 
                document.getElementById('reset-btn').style.display = 'block'; 
                const winnerId = Object.keys(players).find(id => !players[id].isOut);
                document.getElementById('turn-msg').innerText = "Winner: " + (players[winnerId]?.name || "NONE");
            }
        });
    }

    function startGameSession() {
        const newGenre = genres[Math.floor(Math.random() * genres.length)];
        db.ref(`rooms/${roomId}/config`).set({ status: 'setup', genre: newGenre });
    }

    function confirmSecretWord() { if (currentInput.length === 0) return; db.ref(`rooms/${roomId}/players/${myId}`).update({ word: currentInput, isReady: true }); currentInput = ""; }
    
    function updateBattleUI(data) {
        const players = data.players; const playerIds = Object.keys(players);
        document.getElementById('battle-genre').innerText = `お題: ${data.config.genre}`;
        const listDiv = document.getElementById('player-list'); listDiv.innerHTML = "";
        
        playerIds.forEach(id => {
            const p = players[id]; const card = document.createElement('div');
            card.className = `player-card ${id === data.turn ? 'active-turn' : ''} ${p.isOut ? 'eliminated' : ''}`;
            const display = p.word.split("").map(c => (p.hits && p.hits.includes(c)) ? `<span style="color:var(--neon-pink)">${c}</span>` : (id === myId ? c : "？")).join("");
            card.innerHTML = `<strong>${p.name}</strong><br>[ ${display} ]${p.isOut ? ' (DEAD)' : ''}`;
            listDiv.appendChild(card);
        });

        const isMyTurn = data.turn === myId && !players[myId].isOut;
        if (!players[myId].isOut) {
            document.getElementById('turn-msg').innerText = isMyTurn ? "YOUR TURN" : `${players[data.turn]?.name} IS AIMING...`;
            document.getElementById('expose-open-btn').style.display = isMyTurn ? 'block' : 'none';
            createKeyboard('attack-grid', (c) => attack(c), data.usedChars || {}, isMyTurn);
        } else {
            document.getElementById('turn-msg').innerText = "脱落しました... 試合を見守りましょう";
            document.getElementById('expose-open-btn').style.display = 'none';
            createKeyboard('attack-grid', null, data.usedChars || {}, false);
        }
    }

    async function attack(char) {
        const snap = await db.ref(`rooms/${roomId}`).get();
        const data = snap.val();
        let hitAny = false;
        Object.keys(data.players).forEach(id => {
            if (data.players[id].isOut) return;
            if (data.players[id].word.includes(char)) {
                hitAny = true;
                const newHits = data.players[id].hits ? [...new Set([...data.players[id].hits, char])] : [char];
                const isOut = data.players[id].word.split("").every(c => newHits.includes(c));
                db.ref(`rooms/${roomId}/players/${id}`).update({ hits: newHits, isOut: isOut });
                if (isOut) showCelebration(data.players[id].name + " を撃破！");
                triggerShake();
            }
        });
        nextTurn(data, char, hitAny ? 'hit' : 'miss');
    }

    function openExposeModal() {
        currentInput = ""; document.getElementById('expose-word-view').innerText = ""; 
        document.getElementById('expose-modal').style.display = 'flex';
        const select = document.getElementById('target-select'); select.innerHTML = "";
        Object.keys(roomDataGlobal.players).forEach(id => {
            if (id !== myId && !roomDataGlobal.players[id].isOut) {
                const opt = document.createElement('option'); opt.value = id; opt.innerText = roomDataGlobal.players[id].name;
                select.appendChild(opt);
            }
        });
        updateTargetPreview();
        createKeyboard('expose-kb', (c) => { if (currentInput.length < 8) { currentInput += c; document.getElementById('expose-word-view').innerText = currentInput; } });
    }

    function updateTargetPreview() {
        const targetId = document.getElementById('target-select').value;
        if (!targetId) { document.getElementById('target-word-preview').innerText = ""; return; }
        const p = roomDataGlobal.players[targetId];
        const display = p.word.split("").map(c => (p.hits && p.hits.includes(c)) ? c : "？").join(" ");
        document.getElementById('target-word-preview').innerText = `ターゲット: ${display}`;
    }

    async function executeExpose() {
        const targetId = document.getElementById('target-select').value;
        const snap = await db.ref(`rooms/${roomId}`).get();
        const data = snap.val();
        const target = data.players[targetId];
        
        if (target.word === currentInput) {
            db.ref(`rooms/${roomId}/players/${targetId}`).update({ isOut: true, hits: target.word.split("") });
            showCelebration(target.name + "を暴いた！！");
        } else {
            db.ref(`rooms/${roomId}/players/${myId}`).update({ isOut: true });
            showCelebration("失敗！！\n自爆脱落...", true);
        }
        triggerShake();
        closeExposeModal(); nextTurn(data, `[${currentInput}]`, 'hit');
    }

    function showCelebration(msg, isFail = false) {
        const overlay = document.getElementById('flash-overlay');
        const text = document.getElementById('flash-message');
        text.innerText = msg;
        overlay.style.background = isFail ? "rgba(255, 0, 0, 0.75)" : "rgba(0, 255, 255, 0.75)";
        overlay.style.display = "flex";
        setTimeout(() => { overlay.style.display = "none"; }, 3500);
    }

    function closeExposeModal() { document.getElementById('expose-modal').style.display = 'none'; }
    function backspace(type) { currentInput = currentInput.slice(0, -1); document.getElementById(type + '-word-view').innerText = currentInput; }

    function nextTurn(data, char, result) {
        const ids = Object.keys(data.players);
        const aliveIds = ids.filter(id => !data.players[id].isOut);
        if (aliveIds.length <= 1) { db.ref(`rooms/${roomId}/config`).update({ status: 'finished' }); return; }
        let nextIdx = (ids.indexOf(data.turn) + 1) % ids.length;
        while (data.players[ids[nextIdx]].isOut) { nextIdx = (nextIdx + 1) % ids.length; }
        db.ref(`rooms/${roomId}`).update({ turn: ids[nextIdx], [`usedChars/${char}`]: result });
    }
    function triggerShake() { const b = document.getElementById('main-body'); b.classList.add('shake'); setTimeout(() => b.classList.remove('shake'), 400); }
    
    function resetGame() {
        alreadyShownOutMsg = false;
        db.ref(`rooms/${roomId}`).get().then(snap => {
            const players = snap.val().players; const updates = {};
            Object.keys(players).forEach(id => { updates[`players/${id}/isReady`] = false; updates[`players/${id}/isOut`] = false; updates[`players/${id}/hits`] = []; updates[`players/${id}/word`] = ""; });
            updates['config'] = { status: 'waiting', genre: '---' }; updates['usedChars'] = null; updates['turn'] = null;
            db.ref(`rooms/${roomId}`).update(updates); currentInput = "";
        });
    }
</script>
</body>
</html>
