<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WORD SHOOTING: ONLINE</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Noto+Sans+JP:wght@400;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-cyan: #00f3ff;
            --neon-pink: #ff00ff;
            --neon-yellow: #ffff00;
            --bg-dark: #050505;
            --danger: #ff003c;
        }
        body {
            background-color: var(--bg-dark);
            color: #fff;
            font-family: 'Orbitron', 'Noto Sans JP', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            touch-action: manipulation;
            overflow-x: hidden;
        }
        #app { width: 100%; max-width: 500px; padding: 10px; box-sizing: border-box; position: relative; }
        .screen { display: none; flex-direction: column; gap: 10px; }
        .active { display: flex; }
        .panel {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--neon-cyan);
            padding: 12px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.3);
            position: relative;
        }
        .main-title {
            text-align: center;
            color: var(--neon-cyan);
            text-shadow: 0 0 10px var(--neon-cyan), 0 0 20px var(--neon-cyan);
            font-size: 2rem;
            margin: 10px 0;
            letter-spacing: 3px;
            font-weight: 700;
        }
        .room-display { font-size: 0.8rem; color: var(--neon-cyan); text-align: right; margin-bottom: 5px; font-weight: bold; }
        .genre-badge {
            background: var(--neon-pink);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 900;
            display: inline-block;
            margin: 5px 0;
            font-size: 1.2rem;
            box-shadow: 0 0 10px var(--neon-pink);
        }
        button {
            width: 100%; background: transparent; color: var(--neon-cyan); border: 2px solid var(--neon-cyan);
            padding: 12px; font-weight: bold; cursor: pointer; font-size: 1.1rem;
            transition: 0.2s; margin-bottom: 8px;
        }
        button:active { background: var(--neon-cyan); color: #000; box-shadow: 0 0 20px var(--neon-cyan); transform: scale(0.95); }
        .action-area { display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; }
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; }
        .key {
            padding: 10px 0; font-size: 1.1rem; background: #111; border: 1px solid #333;
            color: #ccc; text-align: center; border-radius: 4px;
            display: flex; justify-content: center; align-items: center; min-height: 45px;
            transition: transform 0.05s, background 0.2s; user-select: none;
        }
        .key:active { transform: scale(0.85); background: var(--neon-cyan); color: #000; box-shadow: 0 0 25px var(--neon-cyan); }
        .key-flash { animation: flash-cyan 0.3s ease-out; }
        @keyframes flash-cyan {
            0% { background: #fff; box-shadow: 0 0 40px #fff; color: #000; }
            100% { background: #111; box-shadow: 0 0 0px transparent; }
        }
        .key.hit { background: var(--neon-pink); color: white; border-color: white; box-shadow: 0 0 10px var(--neon-pink); }
        .key.miss { opacity: 0.2; }
        .key.active-key { border-color: var(--neon-cyan); color: var(--neon-cyan); background: #1a1a1a; box-shadow: inset 0 0 5px var(--neon-cyan); }
        .key.empty { background: transparent; border: none; visibility: hidden; }
        #player-list { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .player-card { background: #111; border-left: 4px solid #444; padding: 8px; font-size: 0.8rem; border-radius: 4px; }
        .player-card.active-turn { border-left-color: var(--neon-cyan); box-shadow: 0 0 10px var(--neon-cyan); background: #222; }
        .player-card.eliminated { border-left-color: var(--danger); opacity: 0.4; background: #2a0000; }
        .input-display {
            background: #000; border-bottom: 3px solid var(--neon-pink);
            height: 45px; font-size: 1.6rem; display: flex; justify-content: center; align-items: center;
            margin-bottom: 10px; letter-spacing: 4px; color: var(--neon-yellow);
        }
        #flash-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: none; justify-content: center; align-items: center;
            z-index: 2000; pointer-events: none; text-align: center;
        }
        .huge-text {
            font-size: 2.2rem; font-weight: 900; color: #fff; text-shadow: 0 0 30px #000;
            animation: bounce 0.4s infinite alternate; padding: 20px;
        }
        @keyframes bounce { from { transform: scale(1); } to { transform: scale(1.1); } }
        .shake { animation: shake-anim 0.4s ease-in-out; }
        @keyframes shake-anim {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-12px); }
            40%, 80% { transform: translateX(12px); }
        }
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); display: none; flex-direction: column;
            justify-content: flex-start; align-items: center; z-index: 1000; padding: 20px; box-sizing: border-box;
            overflow-y: auto;
        }
    </style>
</head>
<body id="main-body">

<div id="flash-overlay"><div class="huge-text" id="flash-message"></div></div>

<div id="app">
    <div class="main-title">WORD SHOOTING</div>

    <div id="login-screen" class="screen active">
        <div id="login-main" style="display: flex; flex-direction: column; gap: 10px;">
            <button onclick="showLoginFlow('create')">ãƒ«ãƒ¼ãƒ ã‚’ä½œã‚‹</button>
            <button onclick="showLoginFlow('join')">ãƒ«ãƒ¼ãƒ ã«å…¥ã‚‹</button>
        </div>
        <div id="login-create" class="screen">
            <div class="panel">
                <h3>ãƒ«ãƒ¼ãƒ æ–°è¦ä½œæˆ</h3>
                <input type="text" id="create-name" placeholder="ã‚ãªãŸã®åå‰" maxlength="8" style="width:100%; padding:12px; background:#000; color:#fff; border:1px solid var(--neon-cyan); box-sizing:border-box;">
                <input type="text" id="create-room-id" placeholder="ãƒ«ãƒ¼ãƒ ç•ªå·" style="width:100%; padding:12px; background:#000; color:#fff; border:1px solid var(--neon-cyan); margin-top:10px; box-sizing:border-box;">
                <button onclick="joinRoom('create')" style="margin-top:20px;">ä½œæˆã™ã‚‹</button>
                <button onclick="location.reload()" style="border-color:#666; color:#666;">ã‚‚ã©ã‚‹</button>
            </div>
        </div>
        <div id="login-join" class="screen">
            <div class="panel">
                <h3>ãƒ«ãƒ¼ãƒ ã«å‚åŠ </h3>
                <input type="text" id="join-name" placeholder="ã‚ãªãŸã®åå‰" maxlength="8" style="width:100%; padding:12px; background:#000; color:#fff; border:1px solid var(--neon-cyan); box-sizing:border-box;">
                <input type="text" id="join-room-id" placeholder="ãƒ«ãƒ¼ãƒ ç•ªå·" style="width:100%; padding:12px; background:#000; color:#fff; border:1px solid var(--neon-cyan); margin-top:10px; box-sizing:border-box;">
                <button onclick="joinRoom('join')" style="margin-top:20px;">å‚åŠ ã™ã‚‹</button>
                <button onclick="location.reload()" style="border-color:#666; color:#666;">ã‚‚ã©ã‚‹</button>
            </div>
        </div>
    </div>

    <div id="lobby-screen" class="screen">
        <div class="room-display">ãƒ«ãƒ¼ãƒ : <span class="current-room-text">----</span></div>
        <div class="panel" style="text-align:center">
            <h3 style="color:var(--neon-pink);">å¾…æ©Ÿãƒ­ãƒ“ãƒ¼</h3>
            <p>ç¾åœ¨ã®äººæ•°: <span id="player-count">0</span> / 10</p>
            <ul id="lobby-list" style="list-style: none; padding: 0;"></ul>
            <button id="start-btn" onclick="startGameSession()" style="margin-top:20px;">ãƒŸãƒƒã‚·ãƒ§ãƒ³é–‹å§‹</button>
            <button onclick="exitRoom()" style="border-color:#666; color:#666; margin-top:10px;">é€€å‡ºã™ã‚‹</button>
        </div>
    </div>

    <div id="setup-screen" class="screen">
        <div class="panel" style="text-align:center">
            <div id="genre-display" class="genre-badge">ãŠé¡Œ: ---</div>
            <p style="font-size:0.8rem; margin:5px 0;">è‡ªåˆ†ã®è¨€è‘‰ã‚’ã‚»ãƒƒãƒˆ(æœ€å¤§8æ–‡å­—)</p>
            <div class="input-display" id="setup-word-view"></div>
            <div id="setup-controls">
                <div class="action-area">
                    <button id="ready-btn" onclick="confirmSecretWord()" style="border-color:var(--neon-yellow); color:var(--neon-yellow);">æ±ºå®šãƒ»æº–å‚™å®Œäº†ï¼</button>
                    <button onclick="backspace('setup')" style="border-color:#666; color:#666;">1æ–‡å­—æ¶ˆã™</button>
                </div>
                <div class="grid" id="setup-kb"></div>
            </div>
            <div id="setup-wait-msg" style="display:none; margin-top:20px;">
                <h3 style="color:var(--neon-pink);">ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å¾…æ©Ÿä¸­...</h3>
            </div>
        </div>
    </div>

    <div id="battle-screen" class="screen">
        <div class="room-display">ROOM: <span class="current-room-text">----</span></div>
        <div id="battle-genre" class="genre-badge" style="align-self:center">ãŠé¡Œ: ---</div>
        <div id="player-list"></div>
        <div id="turn-msg" style="text-align:center; color:var(--neon-yellow); font-weight:bold; margin-bottom:10px;"></div>
        <div class="action-area">
            <button id="expose-open-btn" style="border-color:var(--neon-pink); color:var(--neon-pink);" onclick="openExposeModal()">ã€ä¸€æ’ƒã€‘ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’ã‚ã°ã</button>
            <button id="reset-btn" style="display:none; border-color:var(--neon-cyan); color:var(--neon-cyan);" onclick="resetToSetup()">æ¬¡ã®ã‚²ãƒ¼ãƒ ã¸ï¼</button>
        </div>
        <div class="grid" id="attack-grid"></div>
    </div>
</div>

<div id="expose-modal" class="modal">
    <div class="modal-content" style="width:100%; max-width:450px;">
        <h2 style="color:var(--neon-pink); text-align:center; margin-top:0;">SNIPE SYSTEM</h2>
        <div class="panel" style="border-color:var(--neon-pink); margin-bottom:10px;">
            <p style="margin:0 0 5px 0; font-size:0.8rem;">ç‹™ã†ç›¸æ‰‹ã‚’é¸æŠï¼š</p>
            <select id="target-select" onchange="updateTargetPreview()" style="width:100%; padding:10px; background:#222; color:#fff; border:1px solid var(--neon-pink); font-size:1rem;"></select>
            <div id="target-word-preview" style="margin-top:10px; font-size:1.2rem; color:var(--neon-cyan); letter-spacing:2px; text-align:center;"></div>
        </div>
        <div class="input-display" id="expose-word-view"></div>
        <div class="action-area">
            <button style="border-color:var(--neon-pink); color:var(--neon-pink); font-size: 1.3rem;" onclick="executeExpose()">FIRE! (ã‚ã°ã)</button>
            <div style="display:flex; gap:5px;">
                <button onclick="backspace('expose')" style="flex:1">DEL</button>
                <button onclick="closeExposeModal()" style="flex:1; border-color:#666; color:#666;">CANCEL</button>
            </div>
        </div>
        <div class="grid" id="expose-kb"></div>
    </div>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyBpVZkp8eaTwyove6n3i9SE0asIUbYKmjY",
      authDomain: "aiue-battle-online.firebaseapp.com",
      databaseURL: "https://aiue-battle-online-default-rtdb.firebaseio.com",
      projectId: "aiue-battle-online",
      storageBucket: "aiue-battle-online.firebasestorage.app",
      messagingSenderId: "1032584345696",
      appId: "1:1032584345696:web:aa3b9ceb4cfed976236b05"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let roomId, myId, myName, currentInput = "";
    let roomDataGlobal = null;
    let alreadyShownOutMsg = false;
    const charLayout = [
        "ã‚", "ã„", "ã†", "ãˆ", "ãŠ", "ã‹", "ã", "ã", "ã‘", "ã“",
        "ã•", "ã—", "ã™", "ã›", "ã", "ãŸ", "ã¡", "ã¤", "ã¦", "ã¨",
        "ãª", "ã«", "ã¬", "ã­", "ã®", "ã¯", "ã²", "ãµ", "ã¸", "ã»",
        "ã¾", "ã¿", "ã‚€", "ã‚", "ã‚‚", "ã‚„", "ã‚†", "ã‚ˆ", null, null,
        "ã‚‰", "ã‚Š", "ã‚‹", "ã‚Œ", "ã‚", "ã‚", "ã‚’", "ã‚“", "ãƒ¼", null
    ];
    const genres = ["å‹•ç‰©", "é£Ÿã¹ç‰©", "ã‚¹ãƒãƒ¼ãƒ„", "å›½å", "ä¹—ã‚Šç‰©", "ä½“ã®ä¸€éƒ¨", "æ–‡æˆ¿å…·", "éƒ½é“åºœçœŒ", "å­¦æ ¡ã«ã‚ã‚‹ã‚‚ã®", "ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼", "ã‚¢ãƒ‹ãƒ¡", "æ¥½å™¨", "è™«", "é­š", "å®¶é›»", "å†¬ã®ã‚‚ã®", "æœ‰åäºº"];

    window.onload = () => {
        const savedRoomId = localStorage.getItem('ws_roomId');
        const savedMyId = localStorage.getItem('ws_myId');
        const savedMyName = localStorage.getItem('ws_myName');
        if (savedRoomId && savedMyId && savedMyName) {
            roomId = savedRoomId; myId = savedMyId; myName = savedMyName;
            document.querySelectorAll('.current-room-text').forEach(el => el.innerText = roomId);
            listenToRoom();
        }
    };

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo(0,0);
    }
    function showLoginFlow(type) {
        document.getElementById('login-main').style.display = 'none';
        document.getElementById('login-' + type).classList.add('active');
    }
    function createKeyboard(containerId, callback, usedChars = {}, isMyTurn = true) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";
        charLayout.forEach(c => {
            const k = document.createElement('div');
            if (c === null) { k.className = 'key empty'; } 
            else {
                k.className = 'key'; k.innerText = c;
                if (usedChars[c]) { k.classList.add(usedChars[c]); } 
                else if (isMyTurn) {
                    k.classList.add('active-key');
                    k.onclick = (e) => { e.preventDefault(); k.classList.add('key-flash'); setTimeout(() => k.classList.remove('key-flash'), 300); callback(c); };
                }
            }
            container.appendChild(k);
        });
    }

    function joinRoom(type) {
        roomId = document.getElementById(type + '-room-id').value.trim();
        myName = document.getElementById(type + '-name').value.trim();
        if (!roomId || !myName) return alert("åå‰ã¨ç•ªå·ã‚’å…¥åŠ›ï¼");
        myId = Math.random().toString(36).substring(2, 10);
        localStorage.setItem('ws_roomId', roomId);
        localStorage.setItem('ws_myId', myId);
        localStorage.setItem('ws_myName', myName);
        document.querySelectorAll('.current-room-text').forEach(el => el.innerText = roomId);
        const joinTime = Date.now();
        db.ref(`rooms/${roomId}/players/${myId}`).set({ name: myName, isReady: false, isOut: false, hits: [], joinedAt: joinTime });
        db.ref(`rooms/${roomId}/players/${myId}`).onDisconnect().remove();
        listenToRoom();
    }

    function exitRoom() {
        if (roomId && myId) {
            db.ref(`rooms/${roomId}/players/${myId}`).remove();
            localStorage.clear();
            location.reload();
        }
    }

    function listenToRoom() {
        db.ref(`rooms/${roomId}`).on('value', snap => {
            const data = snap.val();
            if (!data) return;
            roomDataGlobal = data;
            const players = data.players || {};
            const status = data.config?.status || 'waiting';

            if (data.actionLog && data.actionLog.timestamp > Date.now() - 4000) {
                showCelebration(data.actionLog.message, data.actionLog.isCritical);
            }

            if (players[myId] && players[myId].isOut && !alreadyShownOutMsg) {
                alreadyShownOutMsg = true;
                triggerShake();
            }

            if (status === 'waiting') {
                showScreen('lobby-screen');
                const playerIds = Object.keys(players).sort((a,b) => players[a].joinedAt - players[b].joinedAt);
                document.getElementById('player-count').innerText = playerIds.length;
                const list = document.getElementById('lobby-list'); list.innerHTML = "";
                playerIds.forEach(id => {
                    const li = document.createElement('li');
                    li.innerText = (id === playerIds[0] ? "ğŸ‘‘ " : "âš”ï¸ ") + players[id].name;
                    list.appendChild(li);
                });
                document.getElementById('start-btn').style.display = (myId === playerIds[0]) ? 'block' : 'none';
            }
            if (status === 'setup') {
                alreadyShownOutMsg = false;
                showScreen('setup-screen');
                document.getElementById('genre-display').innerText = `ãŠé¡Œ: ${data.config.genre}`;
                if (players[myId]?.isReady) {
                    document.getElementById('setup-controls').style.display = 'none';
                    document.getElementById('setup-wait-msg').style.display = 'block';
                } else {
                    document.getElementById('setup-controls').style.display = 'block';
                    document.getElementById('setup-wait-msg').style.display = 'none';
                    if (document.getElementById('setup-kb').innerHTML === "") {
                        createKeyboard('setup-kb', (c) => { if (currentInput.length < 8) { currentInput += c; document.getElementById('setup-word-view').innerText = currentInput; } });
                    }
                }
                const pIds = Object.keys(players);
                const allReady = pIds.length >= 2 && pIds.every(id => players[id].isReady);
                if (allReady) { 
                    db.ref(`rooms/${roomId}/config`).update({ status: 'playing' }); 
                    if (!data.turn) {
                        const sortedIds = Object.keys(players).sort((a,b) => players[a].joinedAt - players[b].joinedAt);
                        db.ref(`rooms/${roomId}`).update({ turn: sortedIds[0] }); 
                    }
                }
            }
            if (status === 'playing') { 
                showScreen('battle-screen'); 
                updateBattleUI(data); 
                document.getElementById('reset-btn').style.display = 'none';
            }
            if (status === 'finished') { 
                // â˜…å…¨å“¡ã«ãƒœã‚¿ãƒ³ã‚’å‡ºã™
                document.getElementById('reset-btn').style.display = 'block'; 
                const winnerId = Object.keys(players).find(id => !players[id].isOut);
                document.getElementById('turn-msg').innerText = "Winner: " + (players[winnerId]?.name || "NONE");
            }
        });
    }

    function startGameSession() {
        const newGenre = genres[Math.floor(Math.random() * genres.length)];
        db.ref(`rooms/${roomId}/config`).set({ status: 'setup', genre: newGenre });
    }

    function confirmSecretWord() { if (currentInput.length === 0) return; db.ref(`rooms/${roomId}/players/${myId}`).update({ word: currentInput, isReady: true }); currentInput = ""; }
    
    function updateBattleUI(data) {
        const players = data.players; 
        const sortedIds = Object.keys(players).sort((a,b) => players[a].joinedAt - players[b].joinedAt);
        document.getElementById('battle-genre').innerText = `ãŠé¡Œ: ${data.config.genre}`;
        const listDiv = document.getElementById('player-list'); listDiv.innerHTML = "";
        
        sortedIds.forEach(id => {
            const p = players[id]; const card = document.createElement('div');
            card.className = `player-card ${id === data.turn ? 'active-turn' : ''} ${p.isOut ? 'eliminated' : ''}`;
            const display = p.word.split("").map(c => (p.hits && p.hits.includes(c)) ? `<span style="color:var(--neon-pink)">${c}</span>` : (id === myId ? c : "ï¼Ÿ")).join("");
            card.innerHTML = `<strong>${p.name}</strong> [ ${display} ]${p.isOut ? ' (DEAD)' : ''}`;
            listDiv.appendChild(card);
        });

        const isMyTurn = data.turn === myId && !players[myId].isOut;
        if (!players[myId].isOut) {
            document.getElementById('turn-msg').innerText = isMyTurn ? "YOUR TURN" : `${players[data.turn]?.name} IS AIMING...`;
            document.getElementById('expose-open-btn').style.display = isMyTurn ? 'block' : 'none';
            createKeyboard('attack-grid', (c) => attack(c), data.usedChars || {}, isMyTurn);
        } else {
            document.getElementById('turn-msg').innerText = "è„±è½ã—ã¾ã—ãŸ...";
            document.getElementById('expose-open-btn').style.display = 'none';
            createKeyboard('attack-grid', null, data.usedChars || {}, false);
        }
    }

    async function attack(char) {
        const snap = await db.ref(`rooms/${roomId}`).get();
        const data = snap.val();
        let hitAny = false;
        Object.keys(data.players).forEach(id => {
            if (data.players[id].isOut) return;
            if (data.players[id].word.includes(char)) {
                hitAny = true;
                const newHits = data.players[id].hits ? [...new Set([...data.players[id].hits, char])] : [char];
                const isOut = data.players[id].word.split("").every(c => newHits.includes(c));
                db.ref(`rooms/${roomId}/players/${id}`).update({ hits: newHits, isOut: isOut });
                if (isOut) db.ref(`rooms/${roomId}/actionLog`).set({ message: `${data.players[id].name}ãŒè„±è½ï¼`, timestamp: Date.now(), isCritical: true });
                triggerShake();
            }
        });
        // ã‚¿ãƒ¼ãƒ³ã‚’å›ã™
        nextTurn(data, char, hitAny ? 'hit' : 'miss');
    }

    function openExposeModal() {
        currentInput = ""; document.getElementById('expose-word-view').innerText = ""; 
        document.getElementById('expose-modal').style.display = 'flex';
        const select = document.getElementById('target-select'); select.innerHTML = "";
        Object.keys(roomDataGlobal.players).forEach(id => {
            if (id !== myId && !roomDataGlobal.players[id].isOut) {
                const opt = document.createElement('option'); opt.value = id; opt.innerText = roomDataGlobal.players[id].name;
                select.appendChild(opt);
            }
        });
        updateTargetPreview();
        createKeyboard('expose-kb', (c) => { if (currentInput.length < 8) { currentInput += c; document.getElementById('expose-word-view').innerText = currentInput; } });
        db.ref(`rooms/${roomId}/actionLog`).set({ message: `${myName}ãŒç‹™ã„ã‚’å®šã‚ã¦ã„ã‚‹...`, timestamp: Date.now(), isCritical: false });
    }

    function updateTargetPreview() {
        const targetId = document.getElementById('target-select').value;
        const preview = document.getElementById('target-word-preview');
        if (!targetId) { preview.innerText = ""; return; }
        const p = roomDataGlobal.players[targetId];
        const display = p.word.split("").map(c => (p.hits && p.hits.includes(c)) ? c : "ï¼Ÿ").join(" ");
        preview.innerText = display;
    }

    async function executeExpose() {
        const targetId = document.getElementById('target-select').value;
        const snap = await db.ref(`rooms/${roomId}`).get();
        const data = snap.val();
        const target = data.players[targetId];
        let resultMsg = "";
        
        if (target.word === currentInput) {
            db.ref(`rooms/${roomId}/players/${targetId}`).update({ isOut: true, hits: target.word.split("") });
            resultMsg = `${myName}ãŒ${target.name}ã‚’æš´ã„ãŸï¼`;
        } else {
            db.ref(`rooms/${roomId}/players/${myId}`).update({ isOut: true });
            resultMsg = `${myName}ãŒå¤±æ•—ï¼è‡ªçˆ†ã—ãŸ...`;
        }
        
        db.ref(`rooms/${roomId}/actionLog`).set({ message: resultMsg, timestamp: Date.now(), isCritical: true });
        triggerShake();
        closeExposeModal();
        
        // â˜…ä¿®æ­£: ã‚ã°ãå‡¦ç†ãŒçµ‚ã‚ã£ãŸå¾Œã«å¼·åˆ¶çš„ã«æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸
        const finalSnap = await db.ref(`rooms/${roomId}`).get();
        nextTurn(finalSnap.val(), `[${currentInput}]`, 'hit');
    }

    function showCelebration(msg, isCritical) {
        const overlay = document.getElementById('flash-overlay');
        const text = document.getElementById('flash-message');
        text.innerText = msg;
        overlay.style.background = isCritical ? "rgba(255, 0, 100, 0.7)" : "rgba(0, 200, 255, 0.5)";
        overlay.style.display = "flex";
        setTimeout(() => { overlay.style.display = "none"; }, 3000);
    }

    function closeExposeModal() { document.getElementById('expose-modal').style.display = 'none'; }
    function backspace(type) { currentInput = currentInput.slice(0, -1); document.getElementById(type + '-word-view').innerText = currentInput; }

    function nextTurn(data, char, result) {
        const ids = Object.keys(data.players).sort((a,b) => data.players[a].joinedAt - data.players[b].joinedAt);
        const aliveIds = ids.filter(id => !data.players[id].isOut);
        if (aliveIds.length <= 1) { 
            db.ref(`rooms/${roomId}/config`).update({ status: 'finished' }); 
            return; 
        }
        let currentIdx = ids.indexOf(data.turn);
        let nextIdx = (currentIdx + 1) % ids.length;
        let safety = 0;
        while (data.players[ids[nextIdx]].isOut && safety < ids.length) {
            nextIdx = (nextIdx + 1) % ids.length;
            safety++;
        }
        // åŒæ™‚ã«æ›´æ–°ã™ã‚‹ã“ã¨ã§é€£ç¶šã‚¿ãƒ¼ãƒ³ã‚’é˜²ã
        db.ref(`rooms/${roomId}`).update({ turn: ids[nextIdx], [`usedChars/${char}`]: result });
    }

    function triggerShake() { const b = document.getElementById('main-body'); b.classList.add('shake'); setTimeout(() => b.classList.remove('shake'), 400); }
    
    function resetToSetup() {
        const newGenre = genres[Math.floor(Math.random() * genres.length)];
        const updates = {};
        Object.keys(roomDataGlobal.players).forEach(id => {
            updates[`players/${id}/isReady`] = false;
            updates[`players/${id}/isOut`] = false;
            updates[`players/${id}/hits`] = [];
            updates[`players/${id}/word`] = "";
        });
        updates['config'] = { status: 'setup', genre: newGenre };
        updates['usedChars'] = null;
        updates['turn'] = null;
        updates['actionLog'] = null;
        db.ref(`rooms/${roomId}`).update(updates);
    }
</script>
</body>
</html>
